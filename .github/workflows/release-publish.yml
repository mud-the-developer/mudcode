name: Release Publish

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      scope:
        description: "npm scope (example: @your-npm-id)"
        required: true
        default: "@mudramo"
      tag:
        description: npm dist-tag
        required: false
        default: "latest"
      dry_run:
        description: Dry run publish
        required: true
        type: boolean
        default: true
      profile:
        description: release target profile
        required: true
        type: choice
        default: full
        options:
          - linux
          - full

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs_on: ubuntu-latest
            full_only: false
          - name: linux-arm64
            runs_on: ubuntu-24.04-arm
            full_only: true
          - name: macos-arm64
            runs_on: macos-14
            full_only: true
          - name: macos-x64
            runs_on: macos-13
            full_only: true
          - name: windows-x64
            runs_on: windows-latest
            full_only: true
    if: ${{ matrix.full_only != true || github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.profile == 'full') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install dependencies
        run: bun install

      - name: Build host release binaries
        env:
          MUDCODE_NPM_SCOPE: ${{ github.event_name == 'workflow_dispatch' && inputs.scope || '@mudramo' }}
          MUDCODE_RS_SKIP_LOCAL_BUILD: "1"
        run: bun run build:release:binaries:host

      - name: Upload release fragment
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.name }}
          path: dist/release
          if-no-files-found: error

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: bun install

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist/release-fragments

      - name: Merge release fragments
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist/release
          mkdir -p dist/release

          for fragment in dist/release-fragments/*; do
            [ -d "$fragment" ] || continue
            for pkg in "$fragment"/*; do
              [ -d "$pkg" ] || continue
              name="$(basename "$pkg")"
              if [ "$name" = "npm" ]; then
                continue
              fi
              rm -rf "dist/release/$name"
              cp -R "$pkg" "dist/release/$name"
            done
          done

      - name: Rebuild manifest + npm meta package
        env:
          MUDCODE_NPM_SCOPE: ${{ github.event_name == 'workflow_dispatch' && inputs.scope || '@mudramo' }}
        run: |
          bun run build:release:manifest
          bun run build:release:npm

      - name: Validate tag matches package version
        if: ${{ github.event_name == 'push' }}
        shell: bash
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          PKG_VERSION="$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).version)")"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Tag version (v$TAG_VERSION) does not match package.json version ($PKG_VERSION)."
            exit 1
          fi

      - name: Publish release packages (bun)
        env:
          MUDCODE_NPM_SCOPE: ${{ github.event_name == 'workflow_dispatch' && inputs.scope || '@mudramo' }}
          MUDCODE_RELEASE_PROFILE: ${{ github.event_name == 'workflow_dispatch' && inputs.profile || 'full' }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          ARGS="--pm bun --skip-build --access public --tag ${{ github.event_name == 'workflow_dispatch' && inputs.tag || 'latest' }} --profile ${{ github.event_name == 'workflow_dispatch' && inputs.profile || 'full' }}"
          if [ "${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || false }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          node scripts/publish-release.mjs $ARGS
