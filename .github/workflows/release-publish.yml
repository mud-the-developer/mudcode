name: Release Publish

on:
  workflow_dispatch:
    inputs:
      scope:
        description: npm scope (example: @your-npm-id)
        required: true
        default: "@siisee11"
      tag:
        description: npm dist-tag
        required: false
        default: "latest"
      dry_run:
        description: Dry run publish
        required: true
        type: boolean
        default: true

jobs:
  build:
    name: Build ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x64
            runs_on: ubuntu-latest
          - name: linux-arm64
            runs_on: ubuntu-24.04-arm
          - name: macos-arm64
            runs_on: macos-14
          - name: macos-x64
            runs_on: macos-13
          - name: windows-x64
            runs_on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Install dependencies
        run: bun install

      - name: Build host release binaries
        env:
          DISCODE_NPM_SCOPE: ${{ inputs.scope }}
          DISCODE_RS_SKIP_LOCAL_BUILD: "1"
        run: bun run build:release:binaries:host

      - name: Upload release fragment
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.name }}
          path: dist/release
          if-no-files-found: error

  publish:
    name: Publish
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.9"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: bun install

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: dist/release-fragments

      - name: Merge release fragments
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist/release
          mkdir -p dist/release

          for fragment in dist/release-fragments/*; do
            [ -d "$fragment" ] || continue
            for pkg in "$fragment"/*; do
              [ -d "$pkg" ] || continue
              name="$(basename "$pkg")"
              if [ "$name" = "npm" ]; then
                continue
              fi
              rm -rf "dist/release/$name"
              cp -R "$pkg" "dist/release/$name"
            done
          done

      - name: Rebuild manifest + npm meta package
        env:
          DISCODE_NPM_SCOPE: ${{ inputs.scope }}
        run: |
          bun run build:release:manifest
          bun run build:release:npm

      - name: Publish release packages (bun)
        env:
          DISCODE_NPM_SCOPE: ${{ inputs.scope }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          ARGS="--pm bun --skip-build --access public --tag ${{ inputs.tag }}"
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          node scripts/publish-release.mjs $ARGS
